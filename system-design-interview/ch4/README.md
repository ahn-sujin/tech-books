# 4장. 처리율 제한 장치의 설계

- **정의**
  - 처리율 제한 장치는 클라이언트나 서비스가 보내는 트래픽의 처리율을 제어하는 장치입니다.  
  - 예: HTTP 요청에서 일정 시간 내 요청 횟수를 제한하며, 임계치를 초과하면 추가 요청을 차단합니다.

- **장점**
  - DoS(Denial of Service) 공격에 의한 자원 고갈 방지
    > Dos 공격이란? <br/>
    > : 시스템이 정상적으로 작동하지 못하도록 하는 공격으로, 특정 웹사이트, 서버, 또는 네트워크를 특정 사용자가 사용할 수 없게 만드는 것을 말합니다. (주로 과도한 트래픽이나 악성 코드를 활용하여 시스템을 마비시키거나, 서비스 중단을 유발)
  - 비용 절감
  - 서버 과부하 방지

<br />

## 처리율 제한 알고리즘

### 1. 토큰 버킷 알고리즘

- **동작 원리**: 일정 간격으로 토큰을 버킷에 추가하며 요청마다 토큰을 소비하고 토큰이 없으면 요청 거부한다.
- **장점**
  - 버스트 트래픽(짧은 시간 동안 갑자기 몰리는 급격한 트래픽 증가) 허용 가능
  - 유연한 처리율 제어
- **단점**
  - 구현 복잡
  - 정확한 요청 간격 제어 어려움


### 2. 누출 버킷 알고리즘

- **동작 원리**: 고정된 크기의 큐에 요청을 저장한다. 일정한 속도로 요청 처리하며 큐가 가득 차면 요청 거부한다.
- **장점**
  - 일정한 처리율 유지
  - 버스트 트래픽 완화
- **단점**
  - 버스트 트래픽 처리 지연
  - 큐 관리 필요


### 3. 고정 윈도 카운터 알고리즘

- **동작 원리**: 고정된 시간 창 동안 요청 수를 카운트하여 제한한다.
- **장점**
  - 구현 간단
  - 메모리 효율적
- **단점**
  - 윈도 경계(고정 시간 단위로 나눈 구간의 경계)에서 요청 집중 시 처리율 초과 가능


### 4. 이동 윈도 로깅 알고리즘

- **동작 원리**: 각 요청의 타임스탬프를 기록하며 이동하는 시간 창 내 요청 수 계산하여 제한한다.
- **장점**
  - 정확한 처리율 제어
  - 윈도 경계 문제 없음
- **단점**
  - 메모리 사용량 증가
  - 타임스탬프 관리 필요


### 5. 이동 윈도 카운터 알고리즘

- **동작 원리**: 이동 시간 창을 작은 버킷으로 나누어 요청 수를 집계한다.
- **장점**
  - 정확한 처리율 제어
  - 메모리 효율적
- **단점**
  - 구현 복잡
  - 버킷 관리 필요

<br />

## 처리율 제한 규칙

- 사용자 ID, IP 주소, API 키 등을 기준으로 제한 규칙 설정 가능하다.

**예시**
- 사용자는 초당 2회 이상 새 글 작성 불가
- 같은 IP 주소로 하루에 10개 이상 계정 생성 불가
- 같은 디바이스로 주당 5회 이상 리워드 요청 불가

<br />

## 처리율 한도 초과 트래픽의 처리

- **HTTP 상태 코드**: `429 Too Many Requests` 사용
- **HTTP 헤더**: `Retry-After`를 통해 재시도 가능 시간 안내

<br />

## 분산환경에서의 처리율 제한 구현

### 경쟁 조건
- 여러 인스턴스가 동시에 요청 처리 시 상태 공유 필요

### 동기화 이슈
- 분산 락, 중앙 저장소 등으로 동기화 문제 해결

### 성능 최적화
- 로컬 캐시 사용
- 효율적인 자료구조 활용
