## 캐시

- 값 비싼 **연산 결과** 또는 **자주 참조되는 데이터**를 **메모리** 안에 두고, 뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 **저장소**

### 캐시 계층

- 데이터가 잠시 보관되는 곳으로 데이터 베이스보다 훨씬 빠르다. (성능 개선, 데이터베이스 부하 줄임)
    1. 만일 데이터가 캐시에 있으면 캐시에서 데이터 클라이언트에 반환함 
    2. 없다면 데이터베이스에서 해당 데이터를 읽어 캐시에 저장한 후 클라이언트에 반환함

### 유의할 점

- 캐시를 사용하기 적절한 상황
    
    → 데이터 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어날 때 
    
- 캐시에 두기 적절한 데이터
    
    → 캐시는 데이터를 휘발성 메모리에 두기 때문에 영속적으로 보관할 데이터를 캐시에 두는 것은 바람직하지 않다.
    
- 캐시에 보관된 데이터 만료
    
    → 만료된 데이터는 캐시에서 삭제하는 정책을 마련해 두는 것으 좋다. 정책이 따로 없다면 데이터는 캐시에 계속 남아있게 된다.
    
- 일관성
    
    → 데이터 원본과 캐시 내의 사본이 같아야 한다.
    
- 장애 대체
    
    → 단일 장애 지점 (캐시 서버 한 대만 두는 경우)을 극복하기 위해 여러 지역에 걸쳐 캐시 서버를 분산 시킨다.
    
- 캐시 메모리 크기
    
    → 과할당, 캐시에 보관될 데이터가 갑자기 늘어났을 때 방지
    
- 데이터 방출 정책
    
    → 캐시가 꽉 차버리면 추가로 캐시를 데이터에 넣어야 할 경우 기존 데이터를 내보내야 한다. (LRU, LFU, FIFO)
    

### 결론

**데이터베이스 부하**를 줄일 수 있다.

<br />

## 콘텐츠 전송 네트워크 (CDN)

- CDN은 정적 콘텐츠(이미지, 비디오, CSS, JS)를 전송하는데 쓰이는 지리적으로 분산된 서버의 네트워크
- 클라이언트에서 정적 콘텐츠 요청이 들어왔을 때, 가장 가까운 CDN 서버가 정적 콘텐츠를 전달한다.
    1. CDN 서버의 캐시에 해당 이미지가 없는 경우 서버는 원본 서버에서 요청해 파일을 가져온다.
        1. 있는 경우 바로 CDN 서버에서 전송한다.
    2. 원본 서버가 파일을 CDN서버에 반환한다. 
    3. CDN 서버는 파일을 캐시하고 클라이언트에 반환한다.

### 고려해야 할 사항

- 비용
    - 데이터 전송 양에 따라 요금을 내기 때문에, 자주 사용되지 않는 콘텐츠는 빼두는 것이 좋다.
- 적절한 만료 시한 설정
    - 너무 길면 콘텐츠의 신선도가 떨어지고, 너무 짧으면 원본 서버에 빈번히 접속하게 되어 좋지 않다.
- CDN 장애 대처 방안
    - CDN 자체가 죽었을 때 어떻게 대체할지 방안이 있어야 한다. (예를 들면 문제가 발생하면 원본 서버에서 가져오도록한다던지…)
- 콘텐츠 무효화
    - 만료되지 않은 콘텐츠더라도 CDN에서 제거할 수 있다.

### 결론

정적 콘텐츠는 더 이상 웹 서버(AWS S3)를 통해 서비스하지 않으며 CDN을 통해 제공하여 **더 나은 성능을 보장**한다.

<br />

## 무상태 웹 계층

- 상태 정보를 관계형 데이터베이스나 NoSQL 같은 **지속성 저장소에 보관하고 필요할 때 가져오도록 하는 것**
- 무상태 아키텍처
    - HTTP 요청은 어떤 웹 서버로도 전달될 수 있다.
    - 웹 서버는 상태 정보가 필요한 경우 공유 저장소로부터 데이터를 가져온다. 따라서 웹 서버로부터 물리적으로 분리되어 있다.

## 데이터 센터

- 여러 데이터 센터 중에 가까운 데이터 센터로 안내된다. 통상 이 절차를 **지리적 라우팅**이라고 부른다.
- 데이터 센터 중에 하나에 장애가 발생하면 모든 트래픽은 장애가 없는 데이터 센터로 전송된다.

## 메시지 큐

- 메시지의 무손실(메시지 큐에 일단 보관된 메시지는 소비자가 꺼낼 때까지 안전히 보관)을 보장하는 비동기 통신을 지원하는 컴포넌트(메시지 버퍼)
- 서비스 또는 서버 간의 결합이 느슨해져 규모 확장성이 보장되어야하는 애플리케이션을 구성하기 좋다.
    - 생산자는 소비자 프로세스가 다운되어도 메시지를 발행할 수 있고, 소비자는 생산자 서비스가 가용한 상태가 아니더라고 메시지를 수신할 수 있다.

## 로그, 메트릭 그리고 자동화

### 로그

- 에러 로그 모니터링

### 메트릭

- 메트릭을 잘 수집하면 사업 현황에 관란 유용한 정보를 얻을 수 있고, 시스템의 현재 상태를 파악할 수 있다.
    - CPU, 메모리, 디스크, 데이터베이스 계층 성능, 캐시 계층 성능, 일별 능동 사용자, 수익, 재방문

### 자동화

- CI, 빌드, 테스트, 배포 → 개발 생산성 향상

## 데이터베이스의 규모 확장

### 수직적 확장

- 스케일 업, 기존 서버에 더 많은, 더 고성능의 자원(CPU, RAM, 디스크)을 증설하는 방법

### 수평적 확장

- 샤딩, 더 많은 서버를 추가함으로써 성능을 향상시킨다.
    - 데이터 재 샤딩
    - 유명 인사 문제
    - 조인과 비정규화

## 백만 사용자, 그리고 그 이상

- 웹 계층은 무상태 계층으로
- 모든 계층에 다중화 도입
- 가능한 한 많은 데이터를 캐시할 것
- 여러 데이터 센터를 지원할 것
- 정적 콘텐츠는 CDN을 통해 서비스할 것
- 데이터 계층은 샤딩을 통해 그 규모를 확장할 것
- 각 계층을 독립적 서비스로 분할할 것
- 시스템을 지속적으로 모니터링하고, 자동화 도구들을 활용할 것
